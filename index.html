<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thi Tr·∫Øc Nghi·ªám Online & AI Tutor</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="style-darkmode.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="exam-wrapper">
      <header class="exam-header" id="mainHeader">
        <div class="header-brand">
          <div class="brand-icon">üìù</div>
          <div class="brand-text">
            <h1>Tr·∫Øc Nghi·ªám</h1>
            <p>Master Your Knowledge</p>
          </div>
        </div>

        <div class="header-center">
          <div id="setupPanel" class="setup-panel">
            <div class="file-select-group">
              <label class="btn-upload">
                <input type="file" id="fileInput" accept=".json" />
                <span>üìÇ Ch·ªçn File</span>
              </label>
              <button
                class="btn-icon-drive"
                id="btnSelectDrive"
                title="Ch·ªçn t·ª´ Google Drive"
              >
                ‚òÅÔ∏è Drive
              </button>
            </div>

            <div id="fileStatusLabel" class="file-status">Ch∆∞a ch·ªçn ƒë·ªÅ</div>

            <div class="action-group">
              <div class="time-wrapper">
                <input
                  type="number"
                  id="timeInput"
                  min="1"
                  max="180"
                  value="15"
                  class="input-time"
                />
                <span class="unit">ph√∫t</span>
              </div>
              <button class="btn-start" id="btnStart" disabled>
                B·∫Øt ƒë·∫ßu ‚ñ∂
              </button>
            </div>
          </div>

          <div id="statusPanel" class="status-panel" style="display: none">
            <div class="status-info">
              <div id="examName" class="exam-name-display">ƒêang t·∫£i...</div>
              <div style="font-size: 20px">‚è±Ô∏è</div>
              <div id="timer" class="timer-display">--:--</div>
            </div>
            <div class="status-actions">
              <button id="btnGradeHeader" class="btn-finish">N·ªôp b√†i</button>
              <button id="btnReset" class="btn-outline">‚Ü∫</button>
              <button id="btnToggleNavMobileInHeader" class="mobile-only">
                üìã
              </button>
            </div>
          </div>
        </div>

        <div class="header-right">
          <div id="topResult" class="mini-score" style="display: none">--%</div>
          <button id="btnOpenStudy" class="btn-tool" title="C√°c ch·∫ø ƒë·ªô h·ªçc t·∫≠p">
            üìö
          </button>
          <button id="btnToggleDark" class="btn-tool" title="Ch·∫ø ƒë·ªô t·ªëi/s√°ng">
            üåô
          </button>
          <button id="btnViewHistory" class="btn-tool" title="Xem l·ªãch s·ª≠">
            üìä
          </button>
          <div class="user-dropdown">
            <button id="btnLogin" class="btn-login">ƒêƒÉng nh·∫≠p</button>
            <div id="userSection" style="display: none" class="user-info">
              <img id="userAvatar" src="" alt="User" />
              <button id="btnLogout" class="btn-logout">Exit</button>
            </div>
          </div>
          <button id="btnToggleNavMobile" class="btn-tool desktop-only">
            üìã
          </button>
        </div>

        <button
          id="btnToggleHeaderMobile"
          class="header-toggle-btn mobile-only"
        >
          ‚ñ≤
        </button>
        <div class="progress-container">
          <div class="progress-bar" id="examProgressBar"></div>
        </div>
      </header>

      <div
        id="examHistorySummary"
        class="history-summary-alert"
        style="display: none"
      ></div>

      <main class="exam-body">
        <section class="exam-main">
          <div id="quiz">
            <div class="welcome-state">
              <div class="welcome-icon">üëã</div>
              <h3>S·∫µn s√†ng th·ª≠ th√°ch?</h3>
              <p>
                Ch·ªçn ƒë·ªÅ thi ·ªü tr√™n, c√†i ƒë·∫∑t th·ªùi gian v√† nh·∫•n n√∫t
                <b>"B·∫Øt ƒë·∫ßu"</b>.
              </p>
            </div>
          </div>
          <div
            id="flashcardContainer"
            class="fc-container"
            style="display: none"
          >
            <div class="fc-header-control">
              <div class="fc-progress">
                <span id="fcCurrent">1</span> / <span id="fcTotal">10</span>
              </div>
              <button
                class="btn-outline btn-sm"
                onclick="window.exitFlashcardMode()"
              >
                ‚úï Tho√°t
              </button>
            </div>

            <div class="fc-card-wrapper">
              <div id="fcCard" class="fc-card"></div>
            </div>

            <div class="fc-navigation">
              <button
                id="btnFcPrev"
                class="btn-fc-nav"
                onclick="window.prevFlashcard()"
              >
                ‚¨Ö C√¢u tr∆∞·ªõc
              </button>
              <button
                id="btnFcNext"
                class="btn-fc-nav main"
                onclick="window.nextFlashcard()"
              >
                C√¢u ti·∫øp ‚û°
              </button>
            </div>
          </div>
        </section>

        <div id="questionNavOverlay" class="question-nav-overlay">
          <aside class="question-nav" id="questionNavPanel">
            <div class="question-nav-header">
              <span class="qnav-title" style="font-size: 16px"
                >Danh s√°ch c√¢u h·ªèi</span
              >
              <button
                id="questionNavCloseBtn"
                class="close-btn"
                style="
                  border: none;
                  background: #f1f5f9;
                  width: 32px;
                  height: 32px;
                  border-radius: 50%;
                  font-weight: bold;
                  color: #64748b;
                  font-size: 16px;
                "
              >
                ‚úï
              </button>
            </div>
            <div id="questionList" class="question-list"></div>
            <button
              id="btnGradeNav"
              class="nav-submit"
              style="
                width: 100%;
                margin-top: 20px;
                padding: 12px;
                background: #ef4444;
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
              "
            >
              N·ªôp b√†i ngay
            </button>
          </aside>
        </div>
      </main>

      <footer class="exam-footer">
        <div id="noteArea" class="footer-note"></div>
        <div id="result" class="footer-result"></div>
      </footer>
    </div>

    <div id="historyModal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="historyModalTitle">H·ªì s∆° h·ªçc t·∫≠p</h3>
          <button
            id="btnCloseHistory"
            style="
              border: none;
              background: none;
              font-size: 20px;
              cursor: pointer;
            "
          >
            ‚úï
          </button>
        </div>

        <div
          id="historyOverview"
          class="history-overview"
          style="display: none"
        ></div>

        <div class="history-tabs">
          <button
            class="tab-btn active"
            onclick="window.switchHistoryTab('stats')"
          >
            ‚ö†Ô∏è C√¢u hay sai
          </button>
          <button class="tab-btn" onclick="window.switchHistoryTab('timeline')">
            üìú L·ªãch s·ª≠
          </button>
          <button class="tab-btn" onclick="window.switchHistoryTab('chart')">
            üìà Bi·ªÉu ƒë·ªì & AI
          </button>
        </div>

        <div class="modal-body">
          <div id="tabStats" class="tab-content active">
            <div
              id="filterArea"
              class="stats-filter-wrapper"
              style="padding: 10px 0"
            >
              <label>ƒêang xem th·ªëng k√™ c·ªßa:</label>
              <select
                id="statsFilter"
                class="stats-select"
                onchange="window.filterStats()"
                style="padding: 4px"
              >
                <option value="all">-- T·∫•t c·∫£ c√°c ƒë·ªÅ --</option>
              </select>
            </div>
            <div
              id="currentExamLabel"
              class="exam-focus-label"
              style="display: none"
            ></div>
            <div id="statsList"></div>
          </div>

          <div id="tabTimeline" class="tab-content" style="display: none">
            <div id="timelineList"></div>
          </div>

          <div id="tabChart" class="tab-content" style="display: none">
            <div
              id="chartStats"
              class="chart-stats-row"
              style="display: none"
            ></div>

            <div id="chartContainer" class="chart-container">
              <canvas id="scoreChart"></canvas>
            </div>

            <div id="aiSection" class="ai-section">
              <div class="ai-header" style="flex-wrap: wrap; gap: 10px">
                <div
                  style="display: flex; align-items: center; gap: 10px; flex: 1"
                >
                  <h4
                    style="
                      margin: 0;
                      color: #4f46e5;
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      white-space: nowrap;
                    "
                  >
                    ü§ñ Gia s∆∞ AI
                  </h4>
                  <select
                    id="aiHistorySelect"
                    class="stats-select"
                    style="max-width: 200px; font-size: 13px"
                  ></select>

                  <button
                    id="btnExpandAI"
                    class="btn-icon-small"
                    title="Ph√≥ng to"
                    style="display: none"
                  >
                    ‚õ∂
                  </button>

                  <button
                    id="btnReAnalyzeAI"
                    class="btn-icon-small"
                    title="X√≥a l·ªùi gi·∫£i c≈© v√† ch·∫°y l·∫°i AI"
                    style="display: none; color: #d97706; border-color: #d97706"
                  >
                    ‚Üª Gi·∫£i l·∫°i
                  </button>
                </div>

                <button id="btnAnalyzeAI" class="btn-ai-magic">
                  ‚ú® Ph√¢n t√≠ch l·ªói sai
                </button>
              </div>

              <div id="aiResultBox" style="display: none">
                <button id="btnCloseExpanded" class="btn-close-ai-expanded">
                  ‚úï ƒê√≥ng
                </button>

                <div id="aiLoading" class="ai-loading">
                  <div class="spinner"></div>
                  ƒêang suy nghƒ© & l∆∞u v√†o l·ªãch s·ª≠...
                </div>
                <div id="aiContent"></div>
              </div>
            </div>

            <div
              id="chartMessage"
              style="
                text-align: center;
                padding: 20px;
                color: #64748b;
                display: none;
              "
            >
              Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì (C·∫ßn √≠t nh·∫•t 2 l·∫ßn thi).
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="driveModal" class="modal-overlay" style="display: none">
      <div class="modal-content drive-modal-box">
        <div class="drive-header">
          <div class="drive-brand">
            <span class="drive-logo">‚òÅÔ∏è</span>
            <div class="drive-title">
              <h3>Google Drive</h3>
              <span class="drive-subtitle">Ch·ªçn ƒë·ªÅ thi t·ª´ th∆∞ m·ª•c c·ªßa b·∫°n</span>
            </div>
          </div>
          <button id="btnCloseDrive" class="btn-close-drive">‚úï</button>
        </div>

        <div class="drive-nav-bar">
          <button
            id="btnDriveBack"
            class="btn-drive-nav"
            disabled
            title="Quay l·∫°i"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
          </button>
          <div class="drive-breadcrumb-wrapper">
            <div id="driveBreadcrumb" class="drive-breadcrumb">Trang ch·ªß</div>
          </div>
        </div>

        <div class="drive-body">
          <div id="driveLoading" class="drive-loading">
            <div class="drive-spinner"></div>
            <span>ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</span>
          </div>

          <div id="driveListArea" class="drive-grid"></div>
        </div>
      </div>
    </div>
    <div id="studyOverlay" class="question-nav-overlay" style="z-index: 150">
      <aside class="question-nav study-sidebar">
        <div class="user-stats-card" id="gamificationPanel">
          <div class="card-deco"></div>

          <div class="stats-header">
            <div class="level-badge">
              <span class="lvl-label">LV.</span>
              <span id="userLevel">1</span>
            </div>
            <div class="streak-badge" title="Chu·ªói ng√†y h·ªçc li√™n t·ª•c">
              <span class="fire-icon">üî•</span>
              <span id="streakCount">0</span>
              <span class="streak-label">Ng√†y</span>
            </div>
          </div>

          <div class="xp-container">
            <div class="xp-info">
              <span id="currentXP">0 XP</span>
              <span id="requiredXP">/ 500 XP</span>
            </div>
            <div class="xp-progress-bg">
              <div class="xp-progress-bar" id="xpBar" style="width: 0%">
                <div class="xp-glare"></div>
              </div>
            </div>
          </div>

          <div class="level-title" id="levelTitle">H·ªçc vi√™n m·ªõi</div>
        </div>
        <div class="question-nav-header">
          <span class="qnav-title" style="font-size: 18px"
            >üéØ Ch·ªçn Ch·∫ø ƒë·ªô h·ªçc</span
          >
          <button
            id="btnCloseStudy"
            class="close-btn"
            style="
              border: none;
              background: #f1f5f9;
              width: 32px;
              height: 32px;
              border-radius: 50%;
            "
          >
            ‚úï
          </button>
        </div>

        <div class="study-options">
          <div class="study-card" onclick="window.startReviewMistakes()">
            <div class="st-icon" style="background: #fee2e2; color: #ef4444">
              üéì
            </div>
            <div class="st-info">
              <div class="st-title">√în l·∫°i c√¢u sai</div>
              <div class="st-desc">
                Ch·ªâ l√†m l·∫°i nh·ªØng c√¢u v·ª´a l√†m sai trong b√†i thi g·∫ßn nh·∫•t.
              </div>
            </div>
          </div>

          <div class="study-card" onclick="window.startFlashcardMode()">
            <div class="st-icon" style="background: #e0f2fe; color: #0ea5e9">
              ‚ö°
            </div>
            <div class="st-info">
              <div class="st-title">Flashcard Mode</div>
              <div class="st-desc">
                L√†m ƒë·ªÅ hi·ªán t·∫°i nh∆∞ng hi·ªán ƒë√°p √°n ƒê√∫ng/Sai ngay l·∫≠p t·ª©c.
              </div>
            </div>
          </div>

          <div class="study-card" onclick="window.startWeaknessReview()">
            <div class="st-icon" style="background: #f0fdf4; color: #22c55e">
              üß†
            </div>
            <div class="st-info">
              <div class="st-title">Luy·ªán c√¢u hay sai</div>
              <div class="st-desc">
                T·ªïng h·ª£p t·∫•t c·∫£ c√¢u sai t·ª´ L·ªãch s·ª≠ ƒë·ªÉ √¥n t·∫≠p l·∫°i.
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCnLETNGt33ZGsDwcil5XoX6wz0vktp-pk",
        authDomain: "tracnghiem-9ec40.firebaseapp.com",
        projectId: "tracnghiem-9ec40",
        storageBucket: "tracnghiem-9ec40.firebasestorage.app",
        messagingSenderId: "138196718538",
        appId: "1:138196718538:web:9cab9bfbe62f612821b533",
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const provider = new firebase.auth.GoogleAuthProvider();
    </script>

    <script type="module" src="app.js"></script>
  </body>
</html>
